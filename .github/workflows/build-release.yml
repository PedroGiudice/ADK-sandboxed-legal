name: Build & Release

on:
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build for Linux (.deb, .rpm, .AppImage)'
        type: boolean
        default: true
      build_windows:
        description: 'Build for Windows (.msi, .exe)'
        type: boolean
        default: false
      build_android:
        description: 'Build for Android (.apk)'
        type: boolean
        default: false
      build_ios:
        description: 'Build for iOS (requires Apple secrets)'
        type: boolean
        default: false
      create_release:
        description: 'Create GitHub Release with artifacts'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  # ============================================
  # JOB 1: Test on Linux (always runs first)
  # ============================================
  test:
    name: Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: bun install

      - name: Type check
        run: bun run tsc --noEmit || echo "Type check completed with warnings"

      - name: Build frontend
        run: bun run build

      - name: Check Rust
        working-directory: src-tauri
        run: cargo check

      - name: Summary
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend build: OK" >> $GITHUB_STEP_SUMMARY
          echo "- Rust check: OK" >> $GITHUB_STEP_SUMMARY
          echo "- Ready for platform builds" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: Build Linux
  # ============================================
  build-linux:
    name: Build Linux
    needs: test
    if: ${{ inputs.build_linux }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: bun install

      - name: Build Tauri (Linux)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: bun run tauri build || true  # AppImage may fail without xdg-open

      - name: List artifacts
        run: |
          echo "## Linux Artifacts" >> $GITHUB_STEP_SUMMARY
          find src-tauri/target/release/bundle -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" | while read f; do
            echo "- $(basename $f)" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/*.AppImage.sig
          if-no-files-found: warn

  # ============================================
  # JOB 3: Build Windows
  # ============================================
  build-windows:
    name: Build Windows
    needs: test
    if: ${{ inputs.build_windows }}
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: bun install

      - name: Build Tauri (Windows)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: bun run tauri build

      - name: List artifacts
        shell: bash
        run: |
          echo "## Windows Artifacts" >> $GITHUB_STEP_SUMMARY
          find src-tauri/target/release/bundle -name "*.msi" -o -name "*.exe" | while read f; do
            echo "- $(basename $f)" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn

  # ============================================
  # JOB 4: Build Android
  # ============================================
  build-android:
    name: Build Android
    needs: test
    if: ${{ inputs.build_android }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Install frontend dependencies
        run: bun install

      - name: Initialize Tauri Android
        run: |
          bun run tauri android init || echo "Android already initialized"

      - name: Build Android APK
        env:
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          bun run tauri android build --apk

      - name: List artifacts
        run: |
          echo "## Android Artifacts" >> $GITHUB_STEP_SUMMARY
          find src-tauri/gen/android -name "*.apk" | while read f; do
            echo "- $(basename $f)" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            src-tauri/gen/android/app/build/outputs/apk/**/*.apk
          if-no-files-found: warn

  # ============================================
  # JOB 5: Build iOS (requires macOS + Apple secrets)
  # ============================================
  build-ios:
    name: Build iOS
    needs: test
    if: ${{ inputs.build_ios }}
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

      - name: Install frontend dependencies
        run: bun install

      - name: Initialize Tauri iOS
        run: |
          bun run tauri ios init || echo "iOS already initialized"

      - name: Build iOS (Simulator)
        run: |
          bun run tauri ios build --target aarch64-apple-ios-sim || echo "iOS build requires signing"

      - name: Summary
        run: |
          echo "## iOS Build" >> $GITHUB_STEP_SUMMARY
          echo "iOS build attempted. For App Store distribution, configure:" >> $GITHUB_STEP_SUMMARY
          echo "- APPLE_CERTIFICATE (base64)" >> $GITHUB_STEP_SUMMARY
          echo "- APPLE_CERTIFICATE_PASSWORD" >> $GITHUB_STEP_SUMMARY
          echo "- APPLE_PROVISIONING_PROFILE (base64)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 6: Create Release (optional)
  # ============================================
  release:
    name: Create Release
    needs: [build-linux, build-windows, build-android]
    if: ${{ always() && inputs.create_release && (needs.build-linux.result == 'success' || needs.build-windows.result == 'success' || needs.build-android.result == 'success') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List all artifacts
        run: find artifacts -type f

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '"version"' src-tauri/tauri.conf.json | head -1 | sed 's/.*: "\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate latest.json for updater
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${{ github.repository }}"

          # Find signature files
          LINUX_SIG=""
          WINDOWS_SIG=""

          if [ -f "artifacts/linux-builds/Legal ADK Sandbox_${VERSION}_amd64.AppImage.sig" ]; then
            LINUX_SIG=$(cat "artifacts/linux-builds/Legal ADK Sandbox_${VERSION}_amd64.AppImage.sig")
          fi

          if [ -f "artifacts/windows-builds/Legal ADK Sandbox_${VERSION}_x64-setup.exe.sig" ]; then
            WINDOWS_SIG=$(cat "artifacts/windows-builds/Legal ADK Sandbox_${VERSION}_x64-setup.exe.sig")
          fi

          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See release notes on GitHub",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "signature": "${LINUX_SIG}",
                "url": "https://github.com/${REPO}/releases/download/v${VERSION}/Legal.ADK.Sandbox_${VERSION}_amd64.AppImage"
              },
              "windows-x86_64": {
                "signature": "${WINDOWS_SIG}",
                "url": "https://github.com/${REPO}/releases/download/v${VERSION}/Legal.ADK.Sandbox_${VERSION}_x64-setup.exe"
              }
            }
          }
          EOF

          cat latest.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Legal ADK Sandbox v${{ steps.version.outputs.version }}
          draft: true
          files: |
            latest.json
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
            artifacts/**/*.AppImage.sig
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.exe.sig
            artifacts/**/*.apk
          body: |
            ## Legal ADK Sandbox v${{ steps.version.outputs.version }}

            ### Downloads

            | Platform | File |
            |----------|------|
            | Linux (Debian/Ubuntu) | `.deb` |
            | Linux (Fedora/RHEL) | `.rpm` |
            | Linux (Universal) | `.AppImage` |
            | Windows | `.msi` or `.exe` |
            | Android | `.apk` |

            ### Installation

            **Linux:**
            ```bash
            sudo dpkg -i legal-adk-sandbox_*.deb
            ```

            **Windows:**
            Double-click the `.msi` installer.

            **Android:**
            Enable "Install from unknown sources" and install the APK.
